<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BunnyServer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .slot-empty {
            border: 2px dashed #4b5563;
        }

        .slot-filled {
            border: 2px solid #7c3aed;
            background: #1e1b4b;
        }

        .receiver-card {
            animation: fadeIn .3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #111827;
        }

        ::-webkit-scrollbar-thumb {
            background: #4c1d95;
            border-radius: 3px;
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-100 min-h-screen">

    <!-- NAVBAR -->
    <nav class="bg-gray-900 border-b border-purple-900 px-6 py-4 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <span class="text-2xl">üê∞</span>
            <h1 class="text-xl font-bold text-purple-400">BunnyServer</h1>
        </div>
        <div class="flex items-center gap-3">
            <span id="sysLabel" class="text-sm font-medium px-3 py-1 rounded-full bg-green-900 text-green-300">üü¢
                ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î</span>
            <button onclick="toggleSystem(true)"
                class="px-4 py-2 text-sm font-semibold rounded-lg bg-green-700 hover:bg-green-600 transition">‡πÄ‡∏õ‡∏¥‡∏î</button>
            <button onclick="toggleSystem(false)"
                class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-700 hover:bg-red-600 transition">‡∏õ‡∏¥‡∏î</button>
            <button onclick="loadAll()"
                class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-700 hover:bg-gray-600 transition">üîÑ</button>
        </div>
    </nav>

    <!-- TOOLBAR -->
    <div class="max-w-7xl mx-auto px-6 mt-6 flex flex-wrap gap-3 items-center">
        <button onclick="openAddReceiver()"
            class="flex items-center gap-2 px-5 py-2.5 bg-purple-700 hover:bg-purple-600 rounded-xl font-semibold transition shadow-lg shadow-purple-900/30">
            <span class="text-lg">Ôºã</span> ‡πÄ‡∏û‡∏¥‡πà‡∏° Receiver
        </button>
        <button onclick="openCheckName()"
            class="flex items-center gap-2 px-5 py-2.5 bg-gray-700 hover:bg-gray-600 rounded-xl font-semibold transition">
            üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠
        </button>
        <div id="statsBar" class="ml-auto text-sm text-gray-400"></div>
    </div>

    <!-- GRID -->
    <div id="grid" class="max-w-7xl mx-auto px-6 mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6 pb-10"></div>

    <script>
        let systemEnabled = true;

        async function api(method, path, body) {
            const opts = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            const r = await fetch(path, opts);
            return r.json();
        }

        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false,
            timer: 2500, timerProgressBar: true,
            background: '#1f2937', color: '#f3f4f6',
            iconColor: '#a78bfa'
        });

        function toast(icon, title) { Toast.fire({ icon, title }); }

        async function loadAll() {
            const data = await api('GET', '/list');
            systemEnabled = data.systemEnabled;
            updateSysBadge();
            renderGrid(data.receivers);
            document.getElementById('statsBar').textContent =
                `Receivers: ${data.total} | Total Givers: ${data.receivers.reduce((s, r) => s + r.giverCount, 0)}`;
        }

        function updateSysBadge() {
            const el = document.getElementById('sysLabel');
            el.textContent = systemEnabled ? 'üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î' : 'üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î';
            el.className = `text-sm font-medium px-3 py-1 rounded-full ${systemEnabled ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`;
        }

        async function toggleSystem(enable) {
            const data = await api('POST', '/system', { enabled: enable });
            if (data.success) {
                systemEnabled = enable;
                updateSysBadge();
                toast(enable ? 'success' : 'warning', data.message);
                loadAll();
            }
        }

        function renderGrid(receivers) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            if (!receivers.length) {
                grid.innerHTML = `<div class="col-span-2 text-center py-20 text-gray-500">
      <div class="text-5xl mb-4">üê∞</div>
      <p class="text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Receiver ‡∏Å‡∏î "+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Receiver" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</p>
    </div>`;
                return;
            }
            receivers.forEach(r => grid.appendChild(buildCard(r)));
        }

        function buildCard(r) {
            const card = document.createElement('div');
            card.className = 'receiver-card bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden shadow-xl';
            card.id = `card-${r.id}`;

            const pct = Math.round((r.giverCount / r.maxGivers) * 100);
            const fillColor = r.isFull ? 'bg-red-500' : r.giverCount >= 5 ? 'bg-yellow-500' : 'bg-purple-500';

            let slots = '';
            for (let i = 0; i < r.maxGivers; i++) {
                const g = r.givers[i];
                if (g) {
                    const t = new Date(g.joinedAt).toLocaleTimeString('th-TH');
                    slots += `<div class="slot-filled rounded-lg p-2 text-center relative group cursor-default">
        <div class="text-xs text-purple-300 font-semibold truncate">${g.name}</div>
        <div class="text-xs text-gray-500">${t}</div>
        <button onclick="giverLeave(${r.id},'${g.name}')"
          class="absolute inset-0 w-full h-full rounded-lg bg-red-900/80 opacity-0 group-hover:opacity-100 transition text-xs font-bold text-red-300 flex items-center justify-center">
          ‚úï ‡∏≠‡∏≠‡∏Å
        </button>
      </div>`;
                } else {
                    slots += `<div class="slot-empty rounded-lg p-2 text-center text-gray-600 text-xs flex items-center justify-center">
        ‡∏ß‡πà‡∏≤‡∏á ${i + 1}
      </div>`;
                }
            }

            card.innerHTML = `
    <!-- Header -->
    <div class="bg-gray-800 px-5 py-4 flex items-start justify-between">
      <div>
        <h2 class="text-lg font-bold text-purple-300">${r.name}</h2>
        <p class="text-xs text-gray-400 mt-0.5">
          <span class="font-mono bg-gray-700 px-2 py-0.5 rounded text-yellow-300">Job ID: ${r.jobId}</span>
          <span class="ml-2 text-gray-500">ID: ${r.id}</span>
        </p>
      </div>
      <div class="flex gap-2">
        <button onclick="openEdit(${r.id},'${r.name}','${r.jobId}')"
          class="px-3 py-1.5 text-xs rounded-lg bg-gray-700 hover:bg-gray-600 transition">‚úèÔ∏è</button>
        <button onclick="deleteReceiver(${r.id},'${r.name}')"
          class="px-3 py-1.5 text-xs rounded-lg bg-red-900 hover:bg-red-800 transition">üóëÔ∏è</button>
      </div>
    </div>

    <!-- Progress -->
    <div class="px-5 pt-4">
      <div class="flex justify-between text-xs text-gray-400 mb-1">
        <span>‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ</span>
        <span class="${r.isFull ? 'text-red-400 font-bold' : 'text-purple-300'}">${r.giverCount}/${r.maxGivers} ${r.isFull ? '‚õî ‡πÄ‡∏ï‡πá‡∏°' : ''}</span>
      </div>
      <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
        <div class="${fillColor} h-2 rounded-full transition-all duration-500" style="width:${pct}%"></div>
      </div>
    </div>

    <!-- Slots -->
    <div class="px-5 pt-4 pb-3 grid grid-cols-4 gap-2 min-h-[120px]">
      ${slots}
    </div>

    <!-- Add Giver -->
    <div class="px-5 pb-5 pt-2 border-t border-gray-800 flex gap-2">
      <input id="gi-${r.id}" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ..."
        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-purple-500"
        onkeydown="if(event.key==='Enter') giverJoin(${r.id})"/>
      <button onclick="giverJoin(${r.id})"
        class="px-4 py-2 bg-purple-700 hover:bg-purple-600 rounded-lg text-sm font-semibold transition">
        + ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
      </button>
    </div>`;

            return card;
        }

        // ======= RECEIVER ACTIONS =======
        async function openAddReceiver() {
            const { value } = await Swal.fire({
                title: '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Receiver',
                background: '#1f2937', color: '#f3f4f6',
                html: `
      <input id="rName" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Receiver" style="background:#111827;color:#f3f4f6;border-color:#4b5563"/>
      <input id="rJob"  class="swal2-input" placeholder="Job ID"        style="background:#111827;color:#f3f4f6;border-color:#4b5563"/>`,
                confirmButtonText: '‡∏™‡∏£‡πâ‡∏≤‡∏á', confirmButtonColor: '#7c3aed',
                showCancelButton: true, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', cancelButtonColor: '#374151',
                preConfirm: () => {
                    const name = document.getElementById('rName').value.trim();
                    const jobId = document.getElementById('rJob').value.trim();
                    if (!name || !jobId) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return false; }
                    return { name, jobId };
                }
            });
            if (!value) return;
            const data = await api('POST', '/receivers', value);
            if (data.success) { toast('success', data.message); loadAll(); }
            else toast('error', data.message);
        }

        async function openEdit(id, name, jobId) {
            const { value } = await Swal.fire({
                title: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Receiver',
                background: '#1f2937', color: '#f3f4f6',
                html: `
      <input id="eName" class="swal2-input" value="${name}"  style="background:#111827;color:#f3f4f6;border-color:#4b5563"/>
      <input id="eJob"  class="swal2-input" value="${jobId}" style="background:#111827;color:#f3f4f6;border-color:#4b5563"/>`,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#7c3aed',
                showCancelButton: true, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', cancelButtonColor: '#374151',
                preConfirm: () => ({
                    name: document.getElementById('eName').value.trim(),
                    jobId: document.getElementById('eJob').value.trim()
                })
            });
            if (!value) return;
            const data = await api('PUT', `/receivers/${id}`, value);
            if (data.success) { toast('success', data.message); loadAll(); }
            else toast('error', data.message);
        }

        async function deleteReceiver(id, name) {
            const result = await Swal.fire({
                title: `‡∏•‡∏ö "${name}"?`, text: '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
                icon: 'warning', background: '#1f2937', color: '#f3f4f6',
                confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢', confirmButtonColor: '#dc2626',
                showCancelButton: true, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', cancelButtonColor: '#374151'
            });
            if (!result.isConfirmed) return;
            const data = await api('DELETE', `/receivers/${id}`);
            if (data.success) { toast('success', data.message); loadAll(); }
            else toast('error', data.message);
        }

        // ======= GIVER ACTIONS =======
        async function giverJoin(receiverId) {
            const input = document.getElementById(`gi-${receiverId}`);
            const name = input.value.trim();
            if (!name) return toast('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠');
            const data = await api('POST', `/receivers/${receiverId}/givers/join`, { name });
            if (data.success) { toast('success', data.message); input.value = ''; loadAll(); }
            else toast('error', data.message);
        }

        async function giverLeave(receiverId, name) {
            const result = await Swal.fire({
                title: `‡∏ô‡∏≥ "${name}" ‡∏≠‡∏≠‡∏Å?`, icon: 'question',
                background: '#1f2937', color: '#f3f4f6',
                confirmButtonText: '‡∏≠‡∏≠‡∏Å', confirmButtonColor: '#dc2626',
                showCancelButton: true, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', cancelButtonColor: '#374151'
            });
            if (!result.isConfirmed) return;
            const data = await api('POST', `/receivers/${receiverId}/givers/leave`, { name });
            if (data.success) { toast('success', data.message); loadAll(); }
            else toast('error', data.message);
        }

        // ======= CHECK NAME =======
        async function openCheckName() {
            const { value: name } = await Swal.fire({
                title: 'üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠', input: 'text',
                inputPlaceholder: '‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
                background: '#1f2937', color: '#f3f4f6',
                inputAttributes: { style: 'background:#111827;color:#f3f4f6;border-color:#4b5563' },
                confirmButtonText: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', confirmButtonColor: '#7c3aed',
                showCancelButton: true, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', cancelButtonColor: '#374151'
            });
            if (!name) return;
            const data = await api('GET', `/check/${encodeURIComponent(name)}`);
            if (!data.found) {
                Swal.fire({ title: '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö', text: data.message, icon: 'info', background: '#1f2937', color: '#f3f4f6', confirmButtonColor: '#7c3aed' });
            } else {
                const roleLabel = data.role === 'receiver' ? 'üéØ ‡∏ï‡∏±‡∏ß‡∏£‡∏±‡∏ö' : 'üéÅ ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ';
                Swal.fire({
                    title: `‚úÖ ‡∏û‡∏ö "${name}"`, icon: 'success',
                    background: '#1f2937', color: '#f3f4f6', confirmButtonColor: '#7c3aed',
                    html: `<div class="text-left text-sm space-y-2 mt-2">
        <p>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: <b class="text-purple-300">${roleLabel}</b></p>
        <p>Job ID: <b class="text-yellow-300 font-mono">${data.jobId}</b></p>
        ${data.receiverName ? `<p>Receiver: <b class="text-purple-300">${data.receiverName}</b></p>` : ''}
        <p>Receiver ID: <b>${data.receiverId}</b></p>
      </div>`
                });
            }
        }

        // Auto-refresh every 5s
        loadAll();
        setInterval(loadAll, 5000);
    </script>
</body>

</html>
